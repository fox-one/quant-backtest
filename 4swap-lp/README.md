# 4swap 流动性 回测

4swap 作为 Mixin 体系内最好的去中心化交易所，将全部手续费收入都奖励给了流动性都提供者。用户只要为交易对提供了流动性便可以分享到该交易对的手续费收入。

然而，由于币价的涨跌，做市者依然需要承担[无常损失](https://zh.cms.fox.one/2020/10/30/%e6%97%a0%e5%b8%b8%e6%8d%9f%e5%a4%b1%e6%98%af%e4%bb%80%e4%b9%88%ef%bc%9f/)。本文以 BigONE 上交易对的历史数据回测，分析了做市的综合收益。

## 怎么回测

由于有大量的机器人在勤勤恳恳的工作着， 4swap 中的交易对价格得以与外部交易所保持一致。本文便以外部交易所中的相应交易对（BigONE XIN/USDT 2019-11-08 至 2020-11-07 间）的历史数据分析做市收益率。

接下去就是一点简单的数学推算，计算出将价格从原始价格推至新价格需要的成交量，从而也就推算出了手续费收入。

### 价格反推成交情况

开始前，还得先来个小科普扫个盲， [4swap 是怎么交易的](https://zh.cms.fox.one/2020/10/15/4swap-%e7%9a%84%e4%bb%b7%e6%a0%bc%e7%94%b1%e4%bb%80%e4%b9%88%e5%86%b3%e5%ae%9a/)。

以下便是无聊的数学推导过程了，具体代码可以自行查看 [swapper.py](swapper.py) 文件了:

```python
# k = base * quote
# k = (base + x) * (quote + y)
# p = quote_new / base_new
#
# 要让价格下跌，base增加，quote减少，收base手续费:
#   base_new = base + x + x * 0.003009 (手续费)
#   quote_new = quote + y
#   k / p = (base + x * 1.003009) * (base + x)
#   0 = 1.003009 * x * x + 2.003009 * base * x + (base * base - k / p)
#
# 要让价格上涨，base减少，quote增加，收quote手续费:
#   base_new = base + x
#   quote_new = quote + y + y * 0.003009 (手续费)
#   k * p = (quote + y) * (quote + y * 1.003009)
#   0 = 1.003009 * y * y + 2.003009 * quote * y + (quote * quote - k * p)
```

有了以上的推导，便可以推算出为了实现价格变动而需要的成交情况。对于每一天的数据都按 (开盘价 => 最高价 => 最低价 => 收盘价) 的方向进行推导，便可以知道经过一天的成交之后的新的流动池的持仓情况了。

#### 价格波动收益

大家都知道， 只要价格在波动，便是源源不断的手续费收入，以下便给大家晒一晒数字:

|  波动幅度   | 收益  |
|  ----  | ----  |
| 0.5%  | 0.000752% |
| 1%  | 0.001506% |
| 2%  | 0.003020% |
| 5%  | 0.007608% |
| 10%  | 0.015419% |

### 收益率怎么计算

以上步骤推导出了流动池的初始持仓，以及最终持仓。收益率便可根据 流动池的最终持仓市值 (value_close) 与 初始持仓情况在现价上的市值 (value_ref) 计算而出。

```python
# 由于流动池中的币对的两个币市值相等，直接使用 2 倍 base
value_close = 2 * base_close
# 初始时的 base + 以及初始时的 quote 在当前可以买到的 base数量
value_ref = base_open + quote_open / latest_price
````

以下就开始晒数据了:

```text
open price: 259.850000
close price: 134.280000
open base: 0.003848
open quote: 1.000000
close base: 0.005539
close quote: 0.743820
price change: -48.3240%
lp profit base: 18.0123%
lp profit quote: -14.6908%
profit: -1.9199%
```

## 总个结

从以上数据可以看到， XIN/USDT 这一年的跌幅将近 50%，然而做市后的综合收益只有 -14.69%。这个数据已经算是优秀的了。

实际上，考虑到回测过程中忽略了无数波动，真是数据应该会比以上好看得多。翻一翻上边的表格，每1个点的波动都会带来不小的收益。想一想，每个币每天的震荡情况，各位听到了背后的金币叮叮当当的响声了没？
